#!/bin/bash

GREEN='\033[0;32m'
CYAN='\033[0;36m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
RESET='\033[0m'
CHECK="\xE2\x9C\x94"
CROSS="\xE2\x9D\x8C"
INFO="\xE2\x84\xB9"

echo -e "${CYAN}${INFO} Mengunduh dan menyiapkan project VPN Bot...${RESET}"

if wget -qO vpn.zip https://rafanstr.github.io/pages/vpn.zip; then
  unzip -q vpn.zip && rm vpn.zip
  cd vpn || { echo -e "${RED}${CROSS} Gagal masuk ke folder vpn${RESET}"; exit 1; }
  npm install
else
  echo -e "${RED}${CROSS} Gagal mengunduh vpn.zip${RESET}"
  exit 1
fi

cd || exit

echo -e "\n${CYAN}${INFO} Masukkan detail konfigurasi:${RESET}"
read -p "ðŸ”‘ BOT_TOKEN     : " token
read -p "ðŸ‘¤ USER_ID       : " id
read -p "ðŸª NAMA_STORE    : " store
read -p "ðŸ’³ DATA_QRIS     : " qris
read -p "ðŸ†” MERCHANT_ID   : " merchant
read -p "ðŸ” API_KEY       : " key

# Buat file konfigurasi JSON
cat > vpn/.vars.json <<EOF
{
  "BOT_TOKEN": "$token",
  "USER_ID": "$id",
  "NAMA_STORE": "$store",
  "PORT": "50123",
  "DATA_QRIS": "$qris",
  "MERCHANT_ID": "$merchant",
  "API_KEY": "$key"
}
EOF

SERVICE_FILE="/etc/systemd/system/sellvpn.service"
cat > "$SERVICE_FILE" <<EOF
[Unit]
Description=VPN Bot Service
After=network.target

[Service]
Type=simple
User=$(whoami)
WorkingDirectory=$(pwd)/vpn
ExecStart=/usr/bin/npm start
Restart=always
RestartSec=3
Environment=PATH=/usr/bin:/usr/local/bin
Environment=NODE_ENV=production

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable sellvpn.service >/dev/null 2>&1
systemctl start sellvpn.service

status=$(systemctl is-active sellvpn.service)
if [[ $status == "active" ]]; then
  echo -e "${GREEN}${CHECK} Service status: OK${RESET}"
  echo "edit pesan utama di file pesan.txt di folder vpn"
else
  echo -e "${RED}${CROSS} Service status: FAILED (${status})${RESET}"
fi

rm -rf bot
